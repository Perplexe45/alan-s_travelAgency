<?php

/**
 * The admin-specific functionality of the plugin.
 * 
 * Defines the plugin name, version, and the hooks that enqueue the
 * admin-specific callbacks, CSS styles and JavaScripts.
 *
 * @link       https://cobweb-security.com
 * @since      1.0.0
 *
 * @package    Cwis
 * @subpackage Cwis/includes/application
 * @author     Cobweb Security <cwis@cobweb-security.com>
 */
class Cwis_Application_Admin extends Cwis_Core_Foundation
{

    /**
     * Modified spider icon passed as base64-encoded SVG
     * By Gergely Korinek (The Noun Project) [CC BY 3.0 (http://creativecommons.org/licenses/by/3.0)], via Wikimedia Commons
     * https://commons.wikimedia.org/wiki/File%3ASpider_icon_(Noun_Project).svg
     */
    private $icon_url = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIgeD0iMCIgeT0iMCIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+PHBhdGggZD0iTTk3LjYgNTYuMWMtOS4zLTYuNS0xOS45LTkuOC0yOC4zLTExLjQgNi44LTMuMiAxNC42LTguOSAyMS41LTE4LjYgMS0xLjUgLjctMy41LS44LTQuNSAtMS41LTEtMy41LS43LTQuNiAuOCAtNi42IDkuNC0xNC4yIDE0LjUtMjAuNCAxNy4yIDMuOC00LjcgNy44LTEyLjEgMTEuNC0yMy45IC41LTEuNy0uNS0zLjUtMi4yLTQuMSAtMS43LS41LTMuNSAuNS00LjEgMi4yIC01LjQgMTguMi0xMS44IDI0LjMtMTUuMyAyNi4zIC0uNS0xLjMtMS4zLTIuNC0yLjMtMyAuMS0uNCAuMi0uOCAuMi0xLjIgMC0xLjYtLjgtMy0xLjktMy4zbC0uNCAzLjhjLS4xIDAtLjIgMC0uMyAwcy0uMiAwLS4zIDBsLS40LTMuOGMtMS4xIC40LTEuOSAxLjctMS45IDMuMyAwIC40IC4xIC44IC4yIDEuMiAtMSAuNy0xLjggMS43LTIuMyAzIC0zLjUtMi05LjgtOC4xLTE1LjMtMjYuMyAtLjUtMS43LTIuMy0yLjctNC4xLTIuMiAtMS43IC41LTIuNyAyLjMtMi4yIDQuMSAzLjUgMTEuNyA3LjUgMTkuMSAxMS4zIDIzLjggLTYuMi0yLjctMTMuOC03LjctMjAuMy0xNy4xIC0xLTEuNS0zLjEtMS44LTQuNS0uOCAtMS41IDEtMS44IDMuMS0uOCA0LjYgNi45IDkuOCAxNC43IDE1LjQgMjEuNSAxOC42IC04LjQgMS42LTE5LjEgNC45LTI4LjMgMTEuNCAtMS41IDEtMS44IDMuMS0uOCA0LjYgLjYgLjkgMS42IDEuNCAyLjcgMS40IC43IDAgMS4zLS4yIDEuOS0uNiA5LjItNi41IDIwLjItOS40IDI4LjMtMTAuNyAtNi44IDUuOS0xNC44IDE3LjEtMjEuNiAzOC4yIC0uNiAxLjcgLjQgMy42IDIuMSA0LjEgLjMgLjEgLjcgLjIgMSAuMiAxLjQgMCAyLjctLjkgMy4xLTIuMyA2LTE4LjYgMTIuOC0yOC42IDE4LjMtMzQgLS41IDEuOC0uOCAzLjgtLjggNS45IDAgOS44IDUuOSAxNy43IDEzLjIgMTcuNyA3LjMgMCAxMy4yLTcuOSAxMy4yLTE3LjcgMC0yLjEtLjMtNC0uOC01LjkgNS41IDUuNCAxMi4zIDE1LjUgMTguMyAzNCAuNCAxLjQgMS43IDIuMyAzLjEgMi4zIC4zIDAgLjctLjEgMS0uMiAxLjctLjYgMi43LTIuNCAyLjEtNC4xIC02LjgtMjEuMS0xNC45LTMyLjMtMjEuNy0zOC4yIDguMSAxLjMgMTkuMSA0LjIgMjguNCAxMC44IC42IC40IDEuMiAuNiAxLjkgLjYgMSAwIDItLjUgMi43LTEuNEM5OS41IDU5LjEgOTkuMSA1Ny4xIDk3LjYgNTYuMXoiIHN0cm9rZT0iZ3JheSIgZmlsbD0iYmxhY2siLz48L3N2Zz4=';
    private $plugin_assets_url;

    public function __construct($plugin_name, $version, $loader = null)
    {
        parent::__construct($plugin_name, $version, $loader);
        $this->plugin_assets_url = plugin_dir_url(CWIS_PLUGIN_DIR_PATH . 'admin/index.php');
    }

    /**
     * Register the function that contains the admin-bar-menu-building code.
     *
     * @since   3.2.3
     */
    public function enqueue_admin_bar_menu()
    {
        global $wp_admin_bar;

        // Adding menu to the Admin bar
        if (isset($wp_admin_bar)) {
            if (get_bloginfo('version') >= 3.8) {
                // Dashicons is the official icon font of the WordPress admin as of 3.8
                $custom_styles = '#wp-admin-bar-cwis-menu .ab-icon{transform:scaleX(-1)}#wp-admin-bar-cwis-menu .ab-icon:before{top:3px;content:"\f332"}';
            } else {
                $custom_styles = '#wp-admin-bar-cwis-menu .ab-icon{display:none}#wp-admin-bar-cwis-menu .ab-label{margin:0}';
            }

            $wp_admin_bar->add_menu(array(
                'id'    => 'cwis-menu',
                'title' => '<span class="ab-icon"></span><span class="ab-label">WebDefender</span><style>' . $custom_styles . '</style>',
                'href'  => admin_url('admin.php?page=cwis-scanner'),
                'meta'  => array(
                    'target' => '_self',
                    'title'  => 'WebDefender Security (formely CWIS Antivirus)'
                ),
            ));

            $wp_admin_bar->add_menu(array(
                'id'    => 'cwis-gdpr-menu',
                'title' => '<span class="ab-label">GDPR</span>',
                'href'  => admin_url('admin.php?page=cwis-gdpr'),
                'meta'  => array(
                    'target' => '_self',
                    'title'  => 'WebDefender GDPR Tools'
                ),
            ));
        }
    }

    /**
     * Register the function that contains the menu-building code for the admin area.
     *
     * @since    1.0.1
     */
    public function enqueue_admin_area_menu()
    {

        // Building the main menu
        $func_application = array($this, 'display_application_main_page');
        add_menu_page('WebDefender Security', 'WebDefender Security', 'manage_options', 'cwis-scanner',
                      $func_application, $this->icon_url);

        // Building the submenu
        add_submenu_page('cwis-scanner', 'Dashboard', 'Dashboard', 'manage_options', 'cwis-scanner', $func_application);
        add_submenu_page('cwis-scanner', 'System Scan', 'System Scan', 'manage_options',
                         'cwis-scanner#/scanner/antivirus', $func_application);
        add_submenu_page('cwis-scanner', 'Scan Results', 'Scan Results', 'manage_options',
                         'cwis-scanner#/scanner/results', $func_application);
        add_submenu_page('cwis-scanner', 'Smart Protection', 'Smart Protection', 'manage_options',
                         'cwis-scanner#/defender', $func_application);
        add_submenu_page('cwis-scanner', 'Blacklist Check', 'Blacklist Check', 'manage_options',
                         'cwis-scanner#/scantools/sitecheck', $func_application);
        add_submenu_page('cwis-scanner', 'System Info', 'System Info', 'manage_options',
                         'cwis-scanner#/scantools/sysinfo', $func_application);
        add_submenu_page('cwis-scanner', 'Settings', 'Settings', 'manage_options', 'cwis-scanner#/settings',
                         $func_application);
    }

    /**
     * Register the function that generates notices for the admin area.
     *
     * @since    2.3.0
     */
    public function enqueue_admin_area_notices()
    {
        global $current_screen;
        global $pagenow;

        // Use global var or get current screen (since WP 3.1)
        if (empty($current_screen) && function_exists('get_current_screen')) {
            $current_screen = get_current_screen();
        }

        // Enqueue notices on dashboard and plugins pages only
        $current_screen_id = isset($current_screen->id) ? $current_screen->id : substr($pagenow, 0, -4);
        if ($current_screen_id !== 'index' && $current_screen_id !== 'dashboard' && $current_screen_id !== 'plugins') {
            return null;
        }

        // Check last scan time (7 * 86400 = week)
        if (time() - get_option('CWIS_LAST_SCAN') < 604800) {
            return null;
        }

        // Add a dismissible notice
        $cwis_scanner_url = 'admin.php?page=cwis-scanner';
        $network_admin_url = function_exists('network_admin_url') ?
                network_admin_url($cwis_scanner_url) : $cwis_scanner_url;
        ?>  
        <div class="notice is-dismissible">
            <p style="font-size:108%">
                <span class="dashicons dashicons-shield" style="vertical-align:text-top;opacity:.7"></span>
                To make your site as secure as possible, take a moment to run a full system scanning in WebDefender Security: 
                &nbsp;<a class="button button-primary" href="<?php echo esc_url($network_admin_url); ?>">Start Scan</a>
                <br>
                <em style="font-size:smaller">Once a week is generally a recommended frequency for a full system scan.
                    This allows your antivirus scanner to run the newest virus definition files against your server system.</em>
            </p>
        </div>
        <?php
    }

    /**
     * Register the JavaScripts for the admin area.
     * 
     * @since    2.0.2
     * @param    string $hook
     */
    public function enqueue_scripts($hook)
    {

        // Enqueue scripts on plugin pages only
        if (false === strpos($hook, 'page_cwis-scanner')) {
            return null;
        }

        $js_files = array(
            // Load vendor files first
            'vendor.js',
            'app.js'
        );

        // Note: wp_enqueue_script() introduced in WordPress 2.1.0
        $plugin_scripts_url = $this->plugin_assets_url . 'scripts/';
        foreach ($js_files as $index => $js_file) {
            $handle = $this->get_plugin_name() . '-file' . $index;
            wp_enqueue_script($handle, $plugin_scripts_url . $js_file, array('jquery'), $this->get_version(), 'all');
        }

        // Smart Protection setting
        $cwis_defender_settings = $this->get_class_instance('Cwis_Defender_Settings');
        $cwsd_smartwaf_setting = (bool) $cwis_defender_settings->get('smartwaf');

        // Localizes CWIS core script (by the last handle used)
        $settings = array(
            'actionUrl'      => admin_url('admin-ajax.php'),
            'currentVersion' => $this->get_version(),
            'pluginAction'   => 'cwis_scanner',
            'pluginAjaxId'   => get_option('CWIS_AJAX_ID'),
            'pluginAjaxPass' => get_option('CWIS_AJAX_PASS'),
            'pluginBaseUrl'  => $this->plugin_assets_url,
            'pluginMode'     => true,
            'pluginType'     => 'wordpress',
            'restNonce'      => get_option('CWIS_REST_NONCE'),
            'useCookies'     => true,
            'useDefender'    => $cwsd_smartwaf_setting
        );
        wp_localize_script($handle, 'CwisSettings', $settings);
    }

    /**
     * Register the stylesheets for the admin area.
     *
     * @since    2.0.2
     * @param    string $hook
     */
    public function enqueue_styles($hook)
    {

        // Enqueue styles on plugin pages only
        if (false === strpos($hook, 'page_cwis-scanner')) {
            return null;
        }

        $css_files = array(
            // Load vendor files first
            'vendor.css',
            'app.css'
        );

        // Note: wp_enqueue_style() introduced in WordPress 2.6.0
        $plugin_styles_url = $this->plugin_assets_url . 'styles/';
        foreach ($css_files as $index => $css_file) {
            wp_enqueue_style($this->get_plugin_name() . '-file' . $index, $plugin_styles_url . $css_file, array(),
                             $this->get_version(), 'all');
        }
    }

    /**
     * Fills scanner's root API file "cwis-scan.php" with AJAX options.
     *
     * @since    1.0.5
     * @param    string $hook
     */
    public function update_scanner_options($hook)
    {
        // Enqueue scripts on plugin pages only
        if (false !== strpos($hook, 'page_cwis-scanner')) {
            // Update last scan time
            update_option('CWIS_LAST_SCAN', time());
        }

        // Run on page "Plugins" only
        if (false === strpos($hook, 'plugins.php')) {
            return null;
        }

        // Validate AJAX options
        if (strlen(get_option('CWIS_AJAX_ID')) === 24 && strlen(get_option('CWIS_AJAX_PASS')) === 24) {
            return null;
        }

        // Generate the new values of AJAX options
        $cwis_ajax_id = wp_generate_password(22, false) . 'ID';
        $cwis_ajax_pass = wp_generate_password(20, false) . 'PASS';

        // Update AJAX options
        update_option('CWIS_AJAX_ID', $cwis_ajax_id);
        update_option('CWIS_AJAX_PASS', $cwis_ajax_pass);
    }

    /**
     * Creates the HTML output for the application main page (screen) displayed.
     * Page link: wp-admin/admin.php?page=cwis-scanner
     *
     * @since    1.0.1
     */
    public function display_application_main_page()
    {
        if (!current_user_can('manage_options')) {
            $message = esc_html__('You do not have sufficient permissions to access this page.', CWIS_PLUGIN_SLUG);
            $this->debug($message);
            wp_die($message);
        }

        require_once CWIS_PLUGIN_DIR_PATH . 'admin/partials/application/main-page.php';
    }

}
